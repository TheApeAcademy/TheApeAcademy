# Deployment Guide - ApeAcademy Platform

## Table of Contents
1. [Quick Start](#quick-start)
2. [Local Development](#local-development)
3. [Docker Deployment](#docker-deployment)
4. [Cloud Deployment](#cloud-deployment)
5. [Security Checklist](#security-checklist)
6. [Troubleshooting](#troubleshooting)

---

## Quick Start

### Requirements
- Node.js v18+
- PostgreSQL 12+
- Git

### 30-Second Setup

```bash
# Clone repo
git clone <repo-url>
cd Premium\ Student\ Assignment\ Platform

# Copy and configure environment
cp .env.example .env
# Edit .env with your database and API keys

# Install dependencies
npm install --legacy-peer-deps

# Run database migrations
npm run db:migrate

# Start development (in separate terminals)
npm run dev              # Frontend at http://localhost:5174
npm run server:dev       # API at http://localhost:3000
```

---

## Local Development

### 1. PostgreSQL Setup

#### Via Homebrew (macOS)
```bash
brew install postgresql
brew services start postgresql
createdb apeacademy
```

#### Via Docker
```bash
docker run --name apeacademy-db \
  -e POSTGRES_USER=apeacademy \
  -e POSTGRES_PASSWORD=apeacademy123 \
  -e POSTGRES_DB=apeacademy \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:15-alpine
```

#### Windows (WSL2)
```bash
# Install PostgreSQL in WSL2
sudo apt update
sudo apt install postgresql
sudo service postgresql start

# Create database
createdb apeacademy
```

### 2. Environment Configuration

```bash
cp .env.example .env
```

Edit `.env`:
```env
# Database (must match your setup)
DATABASE_URL="postgresql://apeacademy:apeacademy123@localhost:5432/apeacademy"

# JWT (generate a strong 32+ char random string)
JWT_SECRET="dev-key-change-in-production-min-32-chars-aksjdhaksjdhaksjdhaksjd"
JWT_EXPIRY="7d"

# Flutterwave (get from https://dashboard.flutterwave.com)
FLUTTERWAVE_PUBLIC_KEY="FLWPUBK_TEST_xxxxx"
FLUTTERWAVE_SECRET_KEY="FLWSECK_TEST_xxxxx"
FLUTTERWAVE_ENCRYPTION_KEY="FLWENC_xxxxx"

# Server
NODE_ENV=development
PORT=3000
API_BASE_URL="http://localhost:3000"
FRONTEND_URL="http://localhost:5174"
```

### 3. Database Initialization

```bash
# Generate Prisma client
npm run db:generate

# Run migrations (creates all tables)
npm run db:migrate

# Optional: Open Prisma Studio to view data
npm run db:studio
```

### 4. Run Development Servers

**Terminal 1 - Frontend (Vite with HMR)**
```bash
npm run dev
# Visit http://localhost:5174
```

**Terminal 2 - Backend API**
```bash
npm run server:dev
# API running at http://localhost:3000
```

### 5. Test the API

```bash
# Health check
curl http://localhost:3000/api/health

# List regions
curl http://localhost:3000/api/regions

# Sign up
curl -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "fullName": "Jane Doe",
    "email": "jane@test.com",
    "password": "TestPass123!",
    "region": "West Africa",
    "country": "Nigeria",
    "educationLevel": "university"
  }'
```

---

## Docker Deployment

### Build & Run Locally

```bash
# Set environment variables (or create .env file)
export JWT_SECRET="your-strong-secret-key-min-32-chars"
export FLUTTERWAVE_PUBLIC_KEY="your_key"
export FLUTTERWAVE_SECRET_KEY="your_secret"

# Start with Docker Compose
docker-compose up -d

# Run migrations
docker-compose exec api npm run db:migrate

# View logs
docker-compose logs -f api

# Access
# Frontend: http://localhost:3000
# API: http://localhost:3000/api
# Database: localhost:5432
```

### Stop Services

```bash
docker-compose down

# Keep database data
docker-compose down -v  # Remove volumes too
```

### Common Commands

```bash
# View running containers
docker-compose ps

# Execute command in API container
docker-compose exec api npm run db:studio

# Rebuild container
docker-compose build --no-cache

# View database logs
docker-compose logs postgres

# Scale API (multiple instances)
docker-compose up -d --scale api=3  # Requires load balancer
```

---

## Cloud Deployment

### Option 1: Railway.app (Recommended for Beginners)

1. **Create Account**: https://railway.app
2. **Connect GitHub**: Link your repo
3. **Create New Project**
4. **Add PostgreSQL Service**
5. **Add Node.js Service**
6. **Set Environment Variables**:
   ```
   DATABASE_URL = (auto-generated by Railway)
   JWT_SECRET = (generate strong key)
   FLUTTERWAVE_PUBLIC_KEY = (from Flutterwave)
   FLUTTERWAVE_SECRET_KEY = (from Flutterwave)
   NODE_ENV = production
   ```
7. **Deploy** via push to `main` branch

**Cost**: Free tier available, $5/month for PostgreSQL

---

### Option 2: Heroku

```bash
# Install Heroku CLI
brew install heroku

# Log in
heroku login

# Create app
heroku create apeacademy-api

# Add PostgreSQL add-on
heroku addons:create heroku-postgresql:essential-0 --app apeacademy-api

# Set environment variables
heroku config:set JWT_SECRET="your-secret" --app apeacademy-api
heroku config:set FLUTTERWAVE_PUBLIC_KEY="your-key" --app apeacademy-api
heroku config:set FLUTTERWAVE_SECRET_KEY="your-secret" --app apeacademy-api

# Deploy
git push heroku main

# Run migrations
heroku run npm run db:migrate --app apeacademy-api

# View logs
heroku logs --tail --app apeacademy-api
```

**Cost**: $7/month (PostgreSQL) + dyno costs

---

### Option 3: DigitalOcean App Platform

1. **Create Account**: https://cloud.digitalocean.com
2. **Go to App Platform** → **Create App**
3. **Connect GitHub** repository
4. **Add Services**:
   - Web Service (Node.js)
   - Database (PostgreSQL)
5. **Configure Environment** in dashboard
6. **Deploy**

**Cost**: $12/month (2GB RAM, auto-scaling)

---

### Option 4: AWS (Scalable, Advanced)

```bash
# Use Elastic Beanstalk
eb init -p "Node.js 20 running on 64bit Amazon Linux 2"
eb create apeacademy-env

# RDS for database
# Set DATABASE_URL to RDS endpoint

eb deploy
eb logs
```

**Cost**: Variable ($10-100+/month depending on scale)

---

### Option 5: VPS (DigitalOcean, Linode, Vultr)

#### 1. Create Droplet (Ubuntu 22.04, 2GB RAM, $6/month)

#### 2. SSH and Setup

```bash
ssh root@your-ip

# Update system
apt update && apt upgrade -y

# Install Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt install -y nodejs

# Install PostgreSQL
apt install -y postgresql postgresql-contrib

# Start PostgreSQL
systemctl start postgresql
systemctl enable postgresql

# Create database
sudo -u postgres createdb apeacademy
sudo -u postgres psql -c "CREATE USER apeacademy WITH PASSWORD 'strong-password';"
sudo -u postgres psql -c "ALTER ROLE apeacademy WITH CREATEDB;"
```

#### 3. Deploy Application

```bash
# Clone repo
git clone <repo> /var/www/apeacademy
cd /var/www/apeacademy

# Install dependencies
npm install --legacy-peer-deps --only=production

# Set environment
cp .env.example .env
nano .env  # Edit with your keys

# Build frontend
npm run build

# Run migrations
npm run db:migrate

# Install PM2 (process manager)
npm install -g pm2

# Start server
pm2 start server/index.mjs --name "apeacademy-api"
pm2 startup
pm2 save

# Setup Nginx reverse proxy
apt install -y nginx

# Create Nginx config
nano /etc/nginx/sites-available/apeacademy
```

**Nginx Config**:
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# Enable site
ln -s /etc/nginx/sites-available/apeacademy /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx

# Setup SSL with Let's Encrypt
apt install -y certbot python3-certbot-nginx
certbot --nginx -d your-domain.com
```

**Cost**: $6/month (droplet) + domain (~$10/year)

---

## Security Checklist

### Before Going Live

- [ ] **JWT_SECRET**: Minimum 32 random characters, never commit to git
- [ ] **Database Password**: Strong, unique, not "password123"
- [ ] **HTTPS**: Always use HTTPS in production (Let's Encrypt free)
- [ ] **CORS**: Set `FRONTEND_URL` to your exact domain (not *)
- [ ] **Rate Limiting**: Consider adding to auth/payment endpoints
- [ ] **HTTPS Redirects**: Redirect all HTTP to HTTPS
- [ ] **Security Headers**: Already enabled with helmet middleware
- [ ] **Password Hashing**: Verified using bcryptjs (10 salt rounds)
- [ ] **Payment Verification**: Never skip Flutterwave API verification
- [ ] **File Uploads**: Validated by type and size
- [ ] **Dependencies**: Run `npm audit` and update packages
- [ ] **Environment Variables**: Never hardcode secrets
- [ ] **Database Backups**: Setup automated daily backups
- [ ] **Logging**: Monitor error logs for anomalies
- [ ] **Admin Access**: Limit database access to app server only

### Production Environment Variables

```env
NODE_ENV=production
JWT_SECRET=<generate-strong-32-char-random-string>
DATABASE_URL=postgresql://user:password@prod-db-host:5432/apeacademy
FLUTTERWAVE_PUBLIC_KEY=FLWPUBK_LIVE_xxxxx
FLUTTERWAVE_SECRET_KEY=FLWSECK_LIVE_xxxxx
API_BASE_URL=https://api.yourdomain.com
FRONTEND_URL=https://yourdomain.com
```

---

## Monitoring & Maintenance

### Monitor Application Health

```bash
# Check API status
curl https://api.yourdomain.com/api/health

# Monitor logs
docker-compose logs -f api

# Or with Heroku
heroku logs --tail --app apeacademy-api
```

### Update Dependencies

```bash
# Check for updates
npm outdated

# Update packages
npm update

# Fix security vulnerabilities
npm audit fix

# Commit and deploy
git add package*.json
git commit -m "chore: update dependencies"
git push origin main
```

### Database Backups

```bash
# Backup PostgreSQL
pg_dump apeacademy > backup-$(date +%Y%m%d).sql

# Restore from backup
psql apeacademy < backup-20260202.sql
```

---

## Troubleshooting

### "Cannot connect to database"

```bash
# Check PostgreSQL is running
brew services list  # macOS

# Check connection string
echo $DATABASE_URL

# Verify credentials
psql -U apeacademy -d apeacademy
```

### "PORT 3000 already in use"

```bash
# Kill process on port 3000
lsof -ti:3000 | xargs kill -9

# Or use different port
PORT=3001 npm run server:dev
```

### "Payment verification failing"

- Verify `FLUTTERWAVE_SECRET_KEY` is correct
- Check Flutterwave API is accessible
- Ensure `transactionId` matches Flutterwave records
- Review `/api/payments/verify/:tx_ref` logs

### "Uploads not persisting"

- Ensure `FILE_UPLOAD_DIR` directory exists
- Check file permissions: `chmod 755 server/uploads`
- Verify disk space available
- Consider switching to Cloudinary if using multiple servers

### "Database migrations fail"

```bash
# Reset database (WARNING: deletes all data)
npx prisma migrate reset

# Or create from scratch
npx prisma db push

# View schema
npm run db:studio
```

---

## Next Steps

1. **Setup Monitoring**: Add Sentry or DataDog for error tracking
2. **Add Webhooks**: Listen for Flutterwave webhooks
3. **Email Service**: Integrate SendGrid for notifications
4. **Analytics**: Track user behavior with Posthog
5. **CDN**: Serve frontend from Cloudflare
6. **SMS**: Add Twilio for delivery updates

---

**Last Updated**: February 2, 2026
**Status**: Production Ready ✅
